<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Firebase for OTP Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-auth-compat.js"></script>
    <div id="recaptcha-container"></div>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.67, maximum-scale=0.67, user-scalable=no">
    <title>BDG GAME - Premium Gaming Platform</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        /* Keep all your existing CSS styles */
        /* Only adding minimal changes for backend connection */
        
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
            color: white;
            overflow-x: hidden;
            zoom: 67%;
            transform: scale(0.67);
            transform-origin: 0 0;
            width: 149.25%;
            height: 149.25%;
        }
        
        /* Login Page Full Screen */
        #login-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            z-index: 10000;
            overflow-y: auto;
        }
        
        #app {
            display: none;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* Hide elements on login page */
        #login-page .header-hidden {
            display: none !important;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #D4AF37;
            border-radius: 10px;
        }
        
        /* Add all your existing CSS styles here */
        /* ... (keep all your existing CSS) ... */
    </style>
</head>
<body class="bg-bdg-dark">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="relative mb-8">
            <div class="w-32 h-32 bg-white/5 rounded-[2rem] flex items-center justify-center backdrop-blur-md border border-gold-primary/30 mb-4">
                <span class="text-5xl font-bold text-gold-primary">BDG</span>
            </div>
            <div class="absolute -inset-4 bg-gradient-to-r from-gold-primary to-gold-secondary rounded-[3rem] blur-xl opacity-20"></div>
        </div>
        <h1 class="text-4xl font-black text-gold-primary italic tracking-tighter mb-2">BDG GAME</h1>
        <p class="text-white/80 text-sm uppercase tracking-[0.3em] font-bold">CONNECTING TO SERVER...</p>
        <div class="mt-8 w-48 h-1 bg-white/10 rounded-full overflow-hidden">
            <div id="loading-progress" class="h-full bg-gold-primary rounded-full"></div>
        </div>
    </div>

    <!-- Login/Registration Page -->
    <div id="login-page" class="login-container">
        <!-- Login form content (keep your existing login form) -->
        <!-- ... (your existing login form HTML) ... -->
    </div>

    <!-- Main App (initially hidden) -->
    <div id="app" class="max-w-md mx-auto min-h-screen bg-bdg-dark pb-20">
        <!-- Main app content (keep your existing app HTML) -->
        <!-- ... (your existing app HTML) ... -->
    </div>

    <!-- WebSocket Status Indicator -->
    <div id="connection-status" class="fixed top-4 right-4 z-50 hidden">
        <div class="flex items-center gap-2 px-3 py-2 rounded-full bg-black/80 backdrop-blur-sm">
            <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse" id="connection-dot"></div>
            <span class="text-xs">Connecting...</span>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCdXXFRUZo0y_jEa4gYyHdMiYxxvNd18Cg",
            authDomain: "bdg-game-4f0eb.firebaseapp.com",
            projectId: "bdg-game-4f0eb",
            storageBucket: "bdg-game-4f0eb.firebasestorage.app",
            messagingSenderId: "56509330896",
            appId: "1:56509330896:web:11441164c5755a27a4f5d5",
            measurementId: "G-6PLHRFXKJH"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'invisible'
        });

        // Backend API Configuration
        const BACKEND_URL = 'https://colorpro-vfgm.onrender.com';
        const WS_URL = BACKEND_URL.replace('http', 'ws');

        // Game State Management
        let gameState = {
            isLoggedIn: false,
            authToken: localStorage.getItem('authToken') || null,
            userData: null,
            balance: 0,
            currentPage: 'home',
            currentGame: 'wingo',
            wingoBet: 0,
            aviatorBet: 0,
            slotsBet: 0,
            ws: null,
            wsConnected: false,
            wingoHistory: [],
            aviatorHistory: [],
            slotsHistory: [],
            transactionHistory: []
        };

        // DOM Elements
        const DOM = {
            loadingScreen: document.getElementById('loading-screen'),
            loginPage: document.getElementById('login-page'),
            app: document.getElementById('app'),
            loginTab: document.getElementById('login-tab'),
            registerTab: document.getElementById('register-tab'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            forgotForm: document.getElementById('forgot-form'),
            loginPhone: document.getElementById('login-phone'),
            loginPassword: document.getElementById('login-password'),
            registerName: document.getElementById('register-name'),
            registerPhone: document.getElementById('register-phone'),
            registerPassword: document.getElementById('register-password'),
            registerConfirmPassword: document.getElementById('register-confirm-password'),
            termsAgree: document.getElementById('terms-agree'),
            otpSection: document.getElementById('otp-section'),
            otpInput: document.getElementById('otp-input'),
            loginBtn: document.getElementById('login-btn'),
            sendOtpBtn: document.getElementById('send-otp-btn'),
            verifyOtpBtn: document.getElementById('verify-otp-btn'),
            balance: document.getElementById('balance'),
            mainBalance: document.getElementById('main-balance'),
            connectionStatus: document.getElementById('connection-status'),
            connectionDot: document.getElementById('connection-dot')
        };

        // Initialize App
        function initApp() {
            console.log('ðŸš€ BDG GAME Initializing...');
            
            // Check if user is already logged in
            const authToken = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            
            if (authToken && userData) {
                try {
                    gameState.authToken = authToken;
                    gameState.userData = JSON.parse(userData);
                    gameState.isLoggedIn = true;
                    
                    // Hide loading screen after 1.5 seconds
                    setTimeout(() => {
                        DOM.loadingScreen.style.display = 'none';
                        DOM.loginPage.style.display = 'none';
                        DOM.app.style.display = 'block';
                        connectWebSocket();
                        updateBalance();
                        initGameListeners();
                    }, 1500);
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    showLoginPage();
                }
            } else {
                showLoginPage();
            }
            
            // Initialize login listeners
            initLoginListeners();
        }

        // Initialize Login Listeners
        function initLoginListeners() {
            // Login/Register tabs
            DOM.loginTab?.addEventListener('click', () => showLoginForm());
            DOM.registerTab?.addEventListener('click', () => showRegisterForm());
            
            // Login button
            DOM.loginBtn?.addEventListener('click', handleLogin);
            
            // Send OTP button
            DOM.sendOtpBtn?.addEventListener('click', sendOtp);
            
            // Verify OTP button
            DOM.verifyOtpBtn?.addEventListener('click', verifyOtp);
        }

        // Show Login Form
        function showLoginForm() {
            DOM.loginForm.classList.remove('hidden');
            DOM.registerForm.classList.add('hidden');
            DOM.forgotForm.classList.add('hidden');
            
            DOM.loginTab.classList.add('text-gold-primary', 'border-b-2', 'border-gold-primary');
            DOM.loginTab.classList.remove('text-white/70');
            DOM.registerTab.classList.add('text-white/70');
            DOM.registerTab.classList.remove('text-gold-primary', 'border-b-2', 'border-gold-primary');
        }

        // Show Register Form
        function showRegisterForm() {
            DOM.loginForm.classList.add('hidden');
            DOM.registerForm.classList.remove('hidden');
            DOM.forgotForm.classList.add('hidden');
            
            DOM.registerTab.classList.add('text-gold-primary', 'border-b-2', 'border-gold-primary');
            DOM.registerTab.classList.remove('text-white/70');
            DOM.loginTab.classList.add('text-white/70');
            DOM.loginTab.classList.remove('text-gold-primary', 'border-b-2', 'border-gold-primary');
        }

        // Show Login Page
        function showLoginPage() {
            setTimeout(() => {
                DOM.loadingScreen.style.display = 'none';
                DOM.loginPage.style.display = 'flex';
            }, 1500);
        }

        // Handle Login
        async function handleLogin() {
            const phone = DOM.loginPhone.value.trim();
            const password = DOM.loginPassword.value.trim();
            
            if (!phone || !password) {
                showNotification('Please enter phone number and password', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mobile: phone,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store auth data
                    gameState.authToken = data.token;
                    gameState.userData = data.user;
                    gameState.isLoggedIn = true;
                    
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userData', JSON.stringify(data.user));
                    
                    // Show main app
                    DOM.loginPage.style.display = 'none';
                    DOM.app.style.display = 'block';
                    
                    // Connect to WebSocket
                    connectWebSocket();
                    
                    // Update UI
                    updateBalance();
                    updateUserProfile();
                    
                    showNotification('Login successful!', 'success');
                } else {
                    showNotification(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Connection error. Please try again.', 'error');
            }
        }

        // Send OTP for Registration
        async function sendOtp() {
            const phone = DOM.registerPhone.value.trim();
            
            if (!phone || phone.length !== 10) {
                showNotification('Please enter valid 10-digit phone number', 'error');
                return;
            }
            
            try {
                const phoneNumber = '+91' + phone;
                const appVerifier = window.recaptchaVerifier;
                
                const confirmationResult = await firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier);
                window.confirmationResult = confirmationResult;
                
                DOM.otpSection.classList.remove('hidden');
                showNotification('OTP sent to your phone', 'success');
            } catch (error) {
                console.error('OTP send error:', error);
                showNotification('Failed to send OTP. Please try again.', 'error');
            }
        }

        // Verify OTP and Register
        async function verifyOtp() {
            const otp = DOM.otpInput.value.trim();
            const name = DOM.registerName.value.trim();
            const phone = DOM.registerPhone.value.trim();
            const password = DOM.registerPassword.value.trim();
            const confirmPassword = DOM.registerConfirmPassword.value.trim();
            
            if (!otp || !name || !phone || !password || !confirmPassword) {
                showNotification('Please fill all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            try {
                // Verify OTP with Firebase
                const result = await window.confirmationResult.confirm(otp);
                
                if (result.user) {
                    // OTP verified, now register with backend
                    const response = await fetch(`${BACKEND_URL}/api/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name,
                            mobile: phone,
                            password: password
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('Registration successful! Please login.', 'success');
                        showLoginForm();
                    } else {
                        showNotification(data.error || 'Registration failed', 'error');
                    }
                }
            } catch (error) {
                console.error('OTP verification error:', error);
                showNotification('Invalid OTP. Please try again.', 'error');
            }
        }

        // Connect to WebSocket
        function connectWebSocket() {
            if (gameState.ws) {
                gameState.ws.close();
            }
            
            const wsUrl = WS_URL;
            gameState.ws = new WebSocket(wsUrl);
            
            gameState.ws.onopen = () => {
                console.log('âœ… WebSocket Connected');
                gameState.wsConnected = true;
                updateConnectionStatus('connected');
                
                // Send authentication
                gameState.ws.send(JSON.stringify({
                    type: 'auth',
                    token: gameState.authToken
                }));
            };
            
            gameState.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('WebSocket message error:', error);
                }
            };
            
            gameState.ws.onclose = () => {
                console.log('âŒ WebSocket Disconnected');
                gameState.wsConnected = false;
                updateConnectionStatus('disconnected');
                
                // Attempt reconnection after 5 seconds
                setTimeout(() => {
                    if (gameState.isLoggedIn) {
                        connectWebSocket();
                    }
                }, 5000);
            };
            
            gameState.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('error');
            };
        }

        // Handle WebSocket Messages
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'balance_update':
                    if (gameState.userData) {
                        gameState.userData.wallet = data.balance;
                        updateBalance();
                    }
                    break;
                    
                case 'game_result':
                    handleGameResult(data);
                    break;
                    
                case 'live_games':
                    updateLiveGames(data.games);
                    break;
                    
                case 'error':
                    showNotification(data.message, 'error');
                    break;
            }
        }

        // Update Connection Status
        function updateConnectionStatus(status) {
            if (!DOM.connectionStatus) return;
            
            DOM.connectionStatus.classList.remove('hidden');
            
            switch (status) {
                case 'connected':
                    DOM.connectionDot.className = 'w-2 h-2 rounded-full bg-green-500';
                    DOM.connectionStatus.querySelector('span').textContent = 'Connected';
                    setTimeout(() => {
                        DOM.connectionStatus.classList.add('hidden');
                    }, 3000);
                    break;
                    
                case 'disconnected':
                    DOM.connectionDot.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                    DOM.connectionStatus.querySelector('span').textContent = 'Disconnected';
                    break;
                    
                case 'error':
                    DOM.connectionDot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                    DOM.connectionStatus.querySelector('span').textContent = 'Connection Error';
                    break;
            }
        }

        // Update Balance Display
        function updateBalance() {
            if (!gameState.userData) return;
            
            const balanceElements = document.querySelectorAll('#balance, #main-balance');
            balanceElements.forEach(el => {
                if (el) {
                    el.textContent = gameState.userData.wallet.toLocaleString('en-IN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
            });
        }

        // Update User Profile
        function updateUserProfile() {
            if (!gameState.userData) return;
            
            const userNameElement = document.querySelector('#account-page h3');
            if (userNameElement) {
                userNameElement.textContent = gameState.userData.name || 'Member';
            }
        }

        // Show Notification
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existing = document.querySelector('.custom-notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `custom-notification fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-transform duration-300 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            }`;
            notification.style.transform = 'translateX(400px)';
            
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'
                    }"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Initialize Game Listeners
        function initGameListeners() {
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = this.dataset.page;
                    navigateToPage(page);
                    
                    // Update active state
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.remove('gold-gradient', 'text-white');
                        b.classList.add('hover:bg-gold-primary/10');
                    });
                    this.classList.add('gold-gradient', 'text-white');
                    this.classList.remove('hover:bg-gold-primary/10');
                });
            });
            
            // Game category buttons
            document.querySelectorAll('.game-category').forEach(btn => {
                btn.addEventListener('click', function() {
                    const game = this.dataset.game;
                    navigateToPage('games');
                    switchGameTab(game);
                });
            });
            
            // Deposit/Withdraw buttons
            document.querySelectorAll('.deposit-btn').forEach(btn => {
                btn.addEventListener('click', () => openModal('deposit'));
            });
            
            document.querySelectorAll('.withdraw-btn').forEach(btn => {
                btn.addEventListener('click', () => openModal('withdraw'));
            });
            
            // Initialize game-specific listeners
            initWingoListeners();
            initAviatorListeners();
            initSlotsListeners();
            
            // Logout button
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
        }

        // Navigation
        function navigateToPage(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // Show selected page
            const pageElement = document.getElementById(`${page}-page`);
            if (pageElement) {
                pageElement.classList.add('active');
            }
            
            // Update page title
            const titles = {
                home: 'Premium Gaming Platform',
                games: 'BDG Games',
                activity: 'Daily Activities',
                promotion: 'Promotions & Referrals',
                account: 'My Account'
            };
            
            const titleElement = document.getElementById('page-title');
            if (titleElement) {
                titleElement.textContent = titles[page] || 'BDG GAME';
            }
            
            // Update header visibility
            const header = document.getElementById('main-header');
            const agentBanner = document.getElementById('agent-banner');
            
            if (page === 'account') {
                if (header) header.classList.add('hidden');
                if (agentBanner) agentBanner.classList.add('hidden');
            } else {
                if (header) header.classList.remove('hidden');
                if (agentBanner) agentBanner.classList.remove('hidden');
            }
        }

        // Switch Game Tab
        function switchGameTab(game) {
            gameState.currentGame = game;
            
            // Update tabs
            document.querySelectorAll('.game-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`.game-tab[data-game="${game}"]`);
            if (activeTab) activeTab.classList.add('active');
            
            // Update sections
            document.querySelectorAll('.game-section').forEach(section => {
                section.classList.remove('active');
            });
            
            const activeSection = document.getElementById(`${game}-section`);
            if (activeSection) activeSection.classList.add('active');
        }

        // Initialize WinGo Listeners
        function initWingoListeners() {
            // Timeframe buttons
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const timeframe = parseInt(this.dataset.timeframe);
                    selectWingoTimeFrame(timeframe);
                });
            });
            
            // Bet amount buttons
            document.querySelectorAll('.wingo-amount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const amount = parseInt(this.dataset.amount);
                    setWingoBetAmount(amount);
                });
            });
            
            // Place bet button
            document.getElementById('wingo-place-bet')?.addEventListener('click', () => {
                placeWingoBet();
            });
        }

        // Initialize Aviator Listeners
        function initAviatorListeners() {
            // Bet amount buttons
            document.querySelectorAll('.aviator-amount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const amount = parseInt(this.dataset.amount);
                    setAviatorBetAmount(amount);
                });
            });
            
            // Place bet button
            document.getElementById('aviator-place-bet')?.addEventListener('click', () => {
                placeAviatorBet();
            });
        }

        // Initialize Slots Listeners
        function initSlotsListeners() {
            // Bet amount buttons
            document.querySelectorAll('.slots-amount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const amount = parseInt(this.dataset.amount);
                    setSlotsBetAmount(amount);
                });
            });
            
            // Spin button
            document.getElementById('spin-btn')?.addEventListener('click', () => {
                spinSlots();
            });
        }

        // WinGo Functions
        function selectWingoTimeFrame(timeframe) {
            gameState.wingoTimeFrame = timeframe;
            
            // Update UI
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('gold-gradient');
                btn.classList.add('bg-bdg-card', 'border', 'border-gold-primary/30');
            });
            
            const selectedBtn = document.querySelector(`.timeframe-btn[data-timeframe="${timeframe}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('gold-gradient');
                selectedBtn.classList.remove('bg-bdg-card', 'border', 'border-gold-primary/30');
            }
            
            // Start timer
            startWingoTimer(timeframe);
        }

        function setWingoBetAmount(amount) {
            gameState.wingoBet = amount;
            document.getElementById('wingo-current-bet').textContent = amount;
            document.getElementById('wingo-potential-win').textContent = (amount * 1.98).toFixed(2);
        }

        function startWingoTimer(timeframe) {
            let timer = timeframe;
            const timerElement = document.getElementById('wingo-timer');
            const timerBar = document.getElementById('wingo-timer-bar');
            
            const interval = setInterval(() => {
                timer--;
                
                if (timerElement) {
                    const mins = Math.floor(timer / 60);
                    const secs = timer % 60;
                    timerElement.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
                
                if (timerBar) {
                    const percentage = (timer / timeframe) * 100;
                    timerBar.style.width = `${percentage}%`;
                }
                
                if (timer <= 0) {
                    clearInterval(interval);
                    simulateWingoResult();
                    setTimeout(() => startWingoTimer(timeframe), 1000);
                }
            }, 1000);
        }

        async function placeWingoBet() {
            if (gameState.wingoBet <= 0) {
                showNotification('Please select bet amount', 'error');
                return;
            }
            
            if (gameState.wingoBet > gameState.userData.wallet) {
                showNotification('Insufficient balance', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/place-bet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameState.authToken}`
                    },
                    body: JSON.stringify({
                        game: 'wingo',
                        amount: gameState.wingoBet,
                        timeframe: gameState.wingoTimeFrame,
                        betType: 'color', // You can modify this based on actual bet
                        betValue: 'red' // You can modify this based on actual bet
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update balance
                    gameState.userData.wallet -= gameState.wingoBet;
                    updateBalance();
                    
                    showNotification('Bet placed successfully', 'success');
                    
                    // Reset bet
                    gameState.wingoBet = 0;
                    document.getElementById('wingo-current-bet').textContent = '0';
                    document.getElementById('wingo-potential-win').textContent = '0';
                } else {
                    showNotification(data.error || 'Bet placement failed', 'error');
                }
            } catch (error) {
                console.error('Bet placement error:', error);
                showNotification('Connection error', 'error');
            }
        }

        function simulateWingoResult() {
            // This would be handled by WebSocket in real implementation
            const resultNumber = Math.floor(Math.random() * 10);
            const resultColor = resultNumber === 0 ? 'green' : 
                               resultNumber >= 1 && resultNumber <= 4 ? 'red' : 'violet';
            
            // Update results display
            const resultsContainer = document.getElementById('wingo-results-container');
            if (resultsContainer) {
                const resultDiv = document.createElement('div');
                const bgColor = resultColor === 'green' ? 'bg-bdg-green' : 
                              resultColor === 'red' ? 'bg-bdg-red' : 'bg-purple-600';
                
                resultDiv.className = `flex-shrink-0 w-16 h-16 ${bgColor} rounded-bdg flex flex-col items-center justify-center`;
                resultDiv.innerHTML = `
                    <p class="text-xs">#${Date.now().toString().slice(-5)}</p>
                    <p class="text-xl font-bold">${resultNumber}</p>
                    <p class="text-xs">${resultNumber >= 5 ? 'Big' : 'Small'}</p>
                `;
                
                resultsContainer.insertBefore(resultDiv, resultsContainer.firstChild);
                
                if (resultsContainer.children.length > 6) {
                    resultsContainer.removeChild(resultsContainer.lastChild);
                }
            }
        }

        // Aviator Functions
        function setAviatorBetAmount(amount) {
            gameState.aviatorBet = amount;
            document.getElementById('aviator-bet').textContent = amount;
        }

        async function placeAviatorBet() {
            if (gameState.aviatorBet <= 0) {
                showNotification('Please select bet amount', 'error');
                return;
            }
            
            if (gameState.aviatorBet > gameState.userData.wallet) {
                showNotification('Insufficient balance', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/place-bet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameState.authToken}`
                    },
                    body: JSON.stringify({
                        game: 'aviator',
                        amount: gameState.aviatorBet
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update balance
                    gameState.userData.wallet -= gameState.aviatorBet;
                    updateBalance();
                    
                    showNotification('Bet placed successfully', 'success');
                    startAviatorGame();
                } else {
                    showNotification(data.error || 'Bet placement failed', 'error');
                }
            } catch (error) {
                console.error('Bet placement error:', error);
                showNotification('Connection error', 'error');
            }
        }

        function startAviatorGame() {
            let multiplier = 1.0;
            const plane = document.querySelector('.aviator-plane-icon');
            const multiplierDisplay = document.getElementById('aviator-multiplier');
            const cashoutBtn = document.getElementById('aviator-cashout-btn');
            const cashoutDisplay = document.getElementById('aviator-cashout');
            
            if (!plane || !multiplierDisplay) return;
            
            // Show cashout button
            if (cashoutBtn) cashoutBtn.classList.remove('hidden');
            
            // Animate plane
            let position = 0;
            const animation = setInterval(() => {
                position += 2;
                multiplier += 0.05;
                
                plane.style.left = `${position}%`;
                multiplierDisplay.textContent = `${multiplier.toFixed(2)}x`;
                
                if (cashoutDisplay) {
                    cashoutDisplay.textContent = (gameState.aviatorBet * multiplier).toFixed(2);
                }
                
                // Random crash between 1.2x and 10x
                if (Math.random() < 0.02 && multiplier > 1.2) {
                    clearInterval(animation);
                    endAviatorGame(multiplier, 'crash');
                }
                
                if (position >= 100) {
                    clearInterval(animation);
                    endAviatorGame(multiplier, 'max');
                }
            }, 100);
            
            // Cashout button handler
            const cashoutHandler = () => {
                clearInterval(animation);
                endAviatorGame(multiplier, 'cashout');
                cashoutBtn.removeEventListener('click', cashoutHandler);
            };
            
            if (cashoutBtn) {
                cashoutBtn.addEventListener('click', cashoutHandler);
            }
        }

        function endAviatorGame(multiplier, reason) {
            const cashoutBtn = document.getElementById('aviator-cashout-btn');
            if (cashoutBtn) cashoutBtn.classList.add('hidden');
            
            // Reset plane position
            const plane = document.querySelector('.aviator-plane-icon');
            if (plane) plane.style.left = '0%';
            
            // Update multiplier display
            const multiplierDisplay = document.getElementById('aviator-multiplier');
            if (multiplierDisplay) multiplierDisplay.textContent = '1.00x';
            
            // Handle win/loss
            if (reason === 'cashout') {
                const winAmount = gameState.aviatorBet * multiplier;
                gameState.userData.wallet += winAmount;
                updateBalance();
                showNotification(`Cashed out at ${multiplier.toFixed(2)}x! Won â‚¹${winAmount.toFixed(2)}`, 'success');
            } else {
                showNotification(`Crashed at ${multiplier.toFixed(2)}x`, 'error');
            }
            
            // Reset bet
            gameState.aviatorBet = 0;
            document.getElementById('aviator-bet').textContent = '0';
            document.getElementById('aviator-cashout').textContent = '0';
        }

        // Slots Functions
        function setSlotsBetAmount(amount) {
            gameState.slotsBet = amount;
            document.getElementById('slots-bet').textContent = amount;
            document.getElementById('slots-win').textContent = (amount * 50).toFixed(2);
        }

        async function spinSlots() {
            if (gameState.slotsBet <= 0) {
                showNotification('Please select bet amount', 'error');
                return;
            }
            
            if (gameState.slotsBet > gameState.userData.wallet) {
                showNotification('Insufficient balance', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/place-bet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameState.authToken}`
                    },
                    body: JSON.stringify({
                        game: 'slots',
                        amount: gameState.slotsBet
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update balance
                    gameState.userData.wallet -= gameState.slotsBet;
                    updateBalance();
                    
                    showNotification('Spin initiated', 'success');
                    animateSlots();
                } else {
                    showNotification(data.error || 'Spin failed', 'error');
                }
            } catch (error) {
                console.error('Spin error:', error);
                showNotification('Connection error', 'error');
            }
        }

        function animateSlots() {
            const reels = [
                document.getElementById('reel1'),
                document.getElementById('reel2'),
                document.getElementById('reel3')
            ];
            
            const symbols = ['diamond', 'gem', 'crown', 'seven', 'bar'];
            const results = [];
            
            // Add spinning class
            reels.forEach(reel => {
                if (reel) {
                    reel.classList.add('spinning');
                    reel.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                }
            });
            
            // Stop spinning after 2 seconds
            setTimeout(() => {
                reels.forEach((reel, index) => {
                    if (reel) {
                        reel.classList.remove('spinning');
                        const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                        results.push(randomSymbol);
                        
                        const icons = {
                            'diamond': 'fa-diamond text-blue-400',
                            'gem': 'fa-gem text-purple-400',
                            'crown': 'fa-crown text-yellow-400',
                            'seven': 'fa-dice text-red-400',
                            'bar': 'fa-chart-bar text-green-400'
                        };
                        
                        reel.innerHTML = `<i class="fas ${icons[randomSymbol]}"></i>`;
                    }
                });
                
                // Check win
                checkSlotsWin(results);
                
                // Reset bet
                gameState.slotsBet = 0;
                document.getElementById('slots-bet').textContent = '0';
                document.getElementById('slots-win').textContent = '0';
            }, 2000);
        }

        function checkSlotsWin(results) {
            if (results[0] === results[1] && results[1] === results[2]) {
                const multipliers = {
                    'diamond': 50,
                    'gem': 25,
                    'crown': 15,
                    'seven': 10,
                    'bar': 5
                };
                
                const multiplier = multipliers[results[0]] || 0;
                const winAmount = gameState.slotsBet * multiplier;
                
                if (winAmount > 0) {
                    gameState.userData.wallet += winAmount;
                    updateBalance();
                    showNotification(`Jackpot! Won â‚¹${winAmount.toFixed(2)}`, 'success');
                }
            }
        }

        // Handle Game Result (from WebSocket)
        function handleGameResult(data) {
            switch (data.game) {
                case 'wingo':
                    updateWingoResult(data);
                    break;
                case 'aviator':
                    updateAviatorResult(data);
                    break;
                case 'slots':
                    updateSlotsResult(data);
                    break;
            }
        }

        // Update Live Games
        function updateLiveGames(games) {
            // Update home page live games
            const wingoTimer = document.getElementById('wingo-30-timer');
            const aviatorCurrent = document.getElementById('aviator-current');
            
            if (wingoTimer && games.wingo) {
                wingoTimer.textContent = `${games.wingo.timer}s`;
            }
            
            if (aviatorCurrent && games.aviator) {
                aviatorCurrent.textContent = `${games.aviator.multiplier}x`;
            }
        }

        // Open Modal
        function openModal(type) {
            const modal = document.getElementById(`${type}-modal`);
            if (modal) {
                modal.classList.add('active');
            }
        }

        // Handle Logout
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear local storage
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
                
                // Reset state
                gameState.isLoggedIn = false;
                gameState.authToken = null;
                gameState.userData = null;
                
                // Close WebSocket
                if (gameState.ws) {
                    gameState.ws.close();
                    gameState.ws = null;
                }
                
                // Show login page
                DOM.app.style.display = 'none';
                DOM.loginPage.style.display = 'flex';
                
                // Clear form
                DOM.loginPhone.value = '';
                DOM.loginPassword.value = '';
                
                showNotification('Logged out successfully', 'success');
            }
        }

        // Initialize when page loads
        window.addEventListener('load', initApp);

        // Expose functions to global scope for HTML event handlers
        window.navigateToPage = navigateToPage;
        window.switchGameTab = switchGameTab;
        window.openModal = openModal;
        window.handleLogout = handleLogout;
        window.showCustomBetInput = function(game) {
            const modal = document.getElementById('custom-bet-input');
            modal.dataset.game = game;
            modal.classList.add('active');
        };
        window.setCustomBet = function() {
            const modal = document.getElementById('custom-bet-input');
            const amount = parseInt(document.getElementById('custom-bet-amount').value);
            const game = modal.dataset.game;
            
            if (amount && amount >= 10) {
                switch (game) {
                    case 'wingo':
                        setWingoBetAmount(amount);
                        break;
                    case 'aviator':
                        setAviatorBetAmount(amount);
                        break;
                    case 'slots':
                        setSlotsBetAmount(amount);
                        break;
                }
                modal.classList.remove('active');
            } else {
                showNotification('Minimum bet amount is â‚¹10', 'error');
            }
        };
    </script>
</body>
</html>