<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Color Trader Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; }
        .sidebar { width: 250px; }
        .content { margin-left: 250px; }
        @media (max-width: 768px) {
            .sidebar { width: 0; position: fixed; }
            .content { margin-left: 0; }
            .sidebar.active { width: 250px; z-index: 1000; }
        }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .table-row:hover { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-red-500 to-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-crown text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Color Trader Pro</h1>
                <p class="text-gray-600 mt-2">Admin Control Panel</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="adminUsername" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                           placeholder="Enter admin username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="adminPassword" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                           placeholder="Enter password">
                </div>
                
                <button onclick="adminLogin()" 
                        class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-3 rounded-lg font-semibold hover:from-red-600 hover:to-red-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-sign-in-alt mr-2"></i> Login as Admin
                </button>
                
                <div class="text-center mt-4 text-sm text-gray-500">
                    <p>Default credentials: admin / admin123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden">
        <!-- Sidebar -->
        <div class="sidebar bg-gray-900 text-white h-screen fixed left-0 top-0 overflow-y-auto">
            <div class="p-6 border-b border-gray-800">
                <h2 class="text-xl font-bold flex items-center">
                    <i class="fas fa-crown mr-3 text-yellow-400"></i>
                    Admin Panel
                </h2>
                <p class="text-gray-400 text-sm mt-1" id="adminRole">Super Admin</p>
            </div>
            
            <nav class="p-4 space-y-2">
                <a href="#dashboard" onclick="loadDashboard()" class="sidebar-item active">
                    <i class="fas fa-tachometer-alt mr-3"></i> Dashboard
                </a>
                <a href="#users" onclick="loadUsers()" class="sidebar-item">
                    <i class="fas fa-users mr-3"></i> Users
                </a>
                <a href="#bets" onclick="loadBets()" class="sidebar-item">
                    <i class="fas fa-coins mr-3"></i> Bets
                </a>
                <a href="#deposits" onclick="loadDeposits()" class="sidebar-item">
                    <i class="fas fa-money-bill-wave mr-3"></i> Deposits
                </a>
                <a href="#withdrawals" onclick="loadWithdrawals()" class="sidebar-item">
                    <i class="fas fa-wallet mr-3"></i> Withdrawals
                </a>
                <a href="#games" onclick="loadGames()" class="sidebar-item">
                    <i class="fas fa-gamepad mr-3"></i> Game Control
                </a>
                <div class="pt-8 border-t border-gray-800">
                    <a href="#logout" onclick="adminLogout()" class="sidebar-item text-red-400">
                        <i class="fas fa-sign-out-alt mr-3"></i> Logout
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="content p-6">
            <!-- Top Bar -->
            <div class="bg-white rounded-xl shadow p-4 mb-6 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard</h1>
                    <p class="text-gray-600" id="pageSubtitle">Welcome back, Admin</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Server Time</p>
                        <p class="font-mono font-bold" id="serverTime">00:00:00</p>
                    </div>
                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user-cog text-red-600"></i>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div id="contentArea">
                <!-- Dashboard will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let adminToken = localStorage.getItem('adminToken');
        let currentPage = 'dashboard';
        
        // Check if already logged in
        if (adminToken) {
            checkAdminAuth();
        }

        // Update server time
        function updateServerTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: false });
            const timeElement = document.getElementById('serverTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }
        setInterval(updateServerTime, 1000);

        // Admin Login
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!username || !password) {
                showAlert('Please enter username and password', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', data.token);
                    showAlert('Login successful!', 'success');
                    
                    // Switch to admin panel
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    
                    // Load dashboard
                    loadDashboard();
                } else {
                    showAlert(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('Connection error. Make sure backend is running.', 'error');
            }
        }

        // Check Admin Authentication
        async function checkAdminAuth() {
            if (!adminToken) return;
            
            try {
                const response = await fetch('http://localhost:5000/api/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                if (response.ok) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadDashboard();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }

        // Admin Logout
        function adminLogout() {
            adminToken = null;
            localStorage.removeItem('adminToken');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // Show Alert
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 animate-in slide-in-from-right ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Sidebar Navigation
        function setActiveSidebar(item) {
            document.querySelectorAll('.sidebar-item').forEach(el => {
                el.classList.remove('active');
            });
            item.classList.add('active');
        }

        // Load Dashboard
        async function loadDashboard() {
            currentPage = 'dashboard';
            document.getElementById('pageTitle').textContent = 'Dashboard';
            document.getElementById('pageSubtitle').textContent = 'Real-time Statistics';
            
            setActiveSidebar(document.querySelector('a[href="#dashboard"]'));
            
            try {
                const response = await fetch('http://localhost:5000/api/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    document.getElementById('contentArea').innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Users Card -->
                            <div class="stat-card bg-white rounded-xl shadow p-6 border-l-4 border-blue-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-gray-600">Total Users</p>
                                        <h3 class="text-3xl font-bold mt-2">${stats.users.total}</h3>
                                        <div class="flex items-center mt-2">
                                            <span class="text-green-500 text-sm font-medium">
                                                <i class="fas fa-users mr-1"></i> ${stats.users.active} Active
                                            </span>
                                        </div>
                                    </div>
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-users text-blue-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Deposits Card -->
                            <div class="stat-card bg-white rounded-xl shadow p-6 border-l-4 border-green-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-gray-600">Total Deposits</p>
                                        <h3 class="text-3xl font-bold mt-2">₹${stats.deposits.total.toLocaleString()}</h3>
                                        <div class="mt-2 space-y-1">
                                            <p class="text-xs text-gray-500">Today: ₹${stats.deposits.today.toLocaleString()}</p>
                                            <p class="text-xs text-gray-500">This Week: ₹${stats.deposits.week.toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Withdrawals Card -->
                            <div class="stat-card bg-white rounded-xl shadow p-6 border-l-4 border-yellow-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-gray-600">Total Withdrawals</p>
                                        <h3 class="text-3xl font-bold mt-2">₹${stats.withdrawals.total.toLocaleString()}</h3>
                                        <div class="mt-2">
                                            <span class="text-red-500 text-sm font-medium">
                                                <i class="fas fa-clock mr-1"></i> ${stats.withdrawals.pending.count} Pending
                                            </span>
                                        </div>
                                    </div>
                                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-wallet text-yellow-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Profit Card -->
                            <div class="stat-card bg-white rounded-xl shadow p-6 border-l-4 border-purple-500">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-gray-600">Platform Profit</p>
                                        <h3 class="text-3xl font-bold mt-2">₹${stats.platform.profit.toLocaleString()}</h3>
                                        <div class="mt-2 space-y-1">
                                            <p class="text-xs text-gray-500">Total Bets: ${stats.bets.total.toLocaleString()}</p>
                                            <p class="text-xs text-gray-500">Today: ${stats.bets.today.toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-xl shadow p-6">
                                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-bolt text-yellow-500 mr-2"></i> Quick Actions
                                </h3>
                                <div class="space-y-3">
                                    <button onclick="loadDeposits()" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 py-3 rounded-lg flex items-center justify-center transition-colors">
                                        <i class="fas fa-check-circle mr-2"></i> Approve Deposits
                                    </button>
                                    <button onclick="loadWithdrawals()" class="w-full bg-green-50 hover:bg-green-100 text-green-700 py-3 rounded-lg flex items-center justify-center transition-colors">
                                        <i class="fas fa-wallet mr-2"></i> Process Withdrawals
                                    </button>
                                    <button onclick="loadGames()" class="w-full bg-purple-50 hover:bg-purple-100 text-purple-700 py-3 rounded-lg flex items-center justify-center transition-colors">
                                        <i class="fas fa-gamepad mr-2"></i> Manage Games
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Recent Activity -->
                            <div class="bg-white rounded-xl shadow p-6 md:col-span-2">
                                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-history text-gray-500 mr-2"></i> Recent Activity
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-red-600"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium">New User Registered</p>
                                                <p class="text-sm text-gray-500">Just now</p>
                                            </div>
                                        </div>
                                        <span class="text-green-500 font-medium">+1</span>
                                    </div>
                                    
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div class="flex items-center">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <i class="fas fa-money-bill text-green-600"></i>
                                            </div>
                                            <div>
                                                <p class="font-medium">Deposit Approved</p>
                                                <p class="text-sm text-gray-500">5 minutes ago</p>
                                            </div>
                                        </div>
                                        <span class="text-green-500 font-medium">+₹${stats.deposits.today.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Status -->
                        <div class="bg-white rounded-xl shadow p-6">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-server text-blue-500 mr-2"></i> System Status
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600">Backend Status</p>
                                    <div class="flex items-center mt-2">
                                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                        <span class="font-medium">Online</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600">Database</p>
                                    <div class="flex items-center mt-2">
                                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                        <span class="font-medium">Connected</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600">WebSocket</p>
                                    <div class="flex items-center mt-2">
                                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                        <span class="font-medium">Active</span>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600">Instant Results</p>
                                    <div class="flex items-center mt-2">
                                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                        <span class="font-medium">Enabled</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
                document.getElementById('contentArea').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold text-red-700 mb-2">Connection Error</h3>
                        <p class="text-red-600">Unable to load dashboard data. Please check backend connection.</p>
                    </div>
                `;
            }
        }

        // Load Users
        async function loadUsers() {
            currentPage = 'users';
            document.getElementById('pageTitle').textContent = 'User Management';
            document.getElementById('pageSubtitle').textContent = 'Manage all registered users';
            
            setActiveSidebar(document.querySelector('a[href="#users"]'));
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">All Users</h2>
                                <p class="text-gray-600">Manage user accounts and balances</p>
                            </div>
                            <div class="mt-4 md:mt-0 flex space-x-3">
                                <div class="relative">
                                    <input type="text" id="userSearch" 
                                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                           placeholder="Search users...">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                                <button onclick="refreshUsers()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-50 text-left text-sm font-medium text-gray-500">
                                        <th class="p-3">User ID</th>
                                        <th class="p-3">Mobile</th>
                                        <th class="p-3">Name</th>
                                        <th class="p-3">Wallet</th>
                                        <th class="p-3">Level</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="7" class="p-8 text-center text-gray-500">
                                            <i class="fas fa-spinner fa-spin mr-2"></i> Loading users...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6 flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                Showing <span id="usersFrom">0</span> to <span id="usersTo">0</span> of <span id="usersTotal">0</span> users
                            </div>
                            <div class="flex space-x-2" id="usersPagination">
                                <!-- Pagination will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load users data
            await fetchUsers();
            
            // Setup search
            document.getElementById('userSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value;
                if (searchTerm.length > 2 || searchTerm.length === 0) {
                    setTimeout(() => fetchUsers(searchTerm), 500);
                }
            });
        }

        // Fetch Users
        async function fetchUsers(search = '', page = 1) {
            try {
                let url = `http://localhost:5000/api/admin/users?page=${page}&limit=20`;
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const users = data.users;
                    const pagination = data.pagination;
                    
                    // Update table
                    const tableBody = document.getElementById('usersTableBody');
                    if (users.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="p-8 text-center text-gray-500">
                                    <i class="fas fa-user-slash text-3xl mb-3 block"></i>
                                    No users found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    let tableHTML = '';
                    users.forEach(user => {
                        const statusClass = user.isActive ? 
                            'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const statusText = user.isActive ? 'Active' : 'Inactive';
                        
                        tableHTML += `
                            <tr class="table-row border-b border-gray-100 hover:bg-gray-50">
                                <td class="p-3">
                                    <div class="font-mono font-bold">${user.userId}</div>
                                </td>
                                <td class="p-3 font-medium">${user.mobile}</td>
                                <td class="p-3">${user.name}</td>
                                <td class="p-3">
                                    <div class="font-bold text-green-600">₹${user.wallet.toFixed(2)}</div>
                                </td>
                                <td class="p-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        ${user.level}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                        ${statusText}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <div class="flex space-x-2">
                                        <button onclick="viewUserDetails('${user.userId}')" 
                                                class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm transition-colors">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="editUserBalance('${user.userId}', '${user.name}', ${user.wallet})" 
                                                class="bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded text-sm transition-colors">
                                            <i class="fas fa-wallet"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableBody.innerHTML = tableHTML;
                    
                    // Update pagination info
                    document.getElementById('usersFrom').textContent = ((page - 1) * 20) + 1;
                    document.getElementById('usersTo').textContent = Math.min(page * 20, pagination.total);
                    document.getElementById('usersTotal').textContent = pagination.total;
                    
                    // Update pagination buttons
                    const paginationDiv = document.getElementById('usersPagination');
                    let paginationHTML = '';
                    
                    if (pagination.pages > 1) {
                        if (page > 1) {
                            paginationHTML += `
                                <button onclick="fetchUsers('${search}', ${page - 1})" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                            `;
                        }
                        
                        for (let i = 1; i <= Math.min(pagination.pages, 5); i++) {
                            if (i === page) {
                                paginationHTML += `
                                    <button class="px-3 py-2 bg-red-500 text-white rounded-lg">
                                        ${i}
                                    </button>
                                `;
                            } else {
                                paginationHTML += `
                                    <button onclick="fetchUsers('${search}', ${i})" 
                                            class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                        ${i}
                                    </button>
                                `;
                            }
                        }
                        
                        if (page < pagination.pages) {
                            paginationHTML += `
                                <button onclick="fetchUsers('${search}', ${page + 1})" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            `;
                        }
                    }
                    
                    paginationDiv.innerHTML = paginationHTML;
                }
            } catch (error) {
                console.error('Fetch users error:', error);
            }
        }

        // View User Details
        async function viewUserDetails(userId) {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const user = data.user;
                    const stats = data.stats;
                    
                    // Create modal
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl shadow-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-xl font-bold text-gray-800">User Details</h3>
                                    <button onclick="this.closest('.fixed').remove()" 
                                            class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times text-2xl"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <!-- User Info -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">User ID</label>
                                            <p class="mt-1 font-mono font-bold">${user.userId}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">Mobile</label>
                                            <p class="mt-1 font-medium">${user.mobile}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">Name</label>
                                            <p class="mt-1 font-medium">${user.name}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">Invite Code</label>
                                            <p class="mt-1 font-mono">${user.inviteCode}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">Wallet Balance</label>
                                            <p class="mt-1 text-2xl font-bold text-green-600">₹${user.wallet.toFixed(2)}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">Level</label>
                                            <span class="mt-1 inline-block px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 font-medium">
                                                ${user.level}
                                            </span>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">Total Profit</label>
                                            <p class="mt-1 font-medium">₹${user.totalProfit.toFixed(2)}</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">Joined Date</label>
                                            <p class="mt-1">${new Date(user.createdAt).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Statistics -->
                                <div class="mb-8">
                                    <h4 class="font-bold text-gray-800 mb-4">Statistics</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="bg-gray-50 p-4 rounded-lg">
                                            <p class="text-sm text-gray-600">Total Bets</p>
                                            <p class="text-xl font-bold">${stats.totalBets || 0}</p>
                                        </div>
                                        <div class="bg-gray-50 p-4 rounded-lg">
                                            <p class="text-sm text-gray-600">Total Deposits</p>
                                            <p class="text-xl font-bold">${stats.totalDeposits || 0}</p>
                                        </div>
                                        <div class="bg-gray-50 p-4 rounded-lg">
                                            <p class="text-sm text-gray-600">Total Withdrawals</p>
                                            <p class="text-xl font-bold">${stats.totalWithdrawals || 0}</p>
                                        </div>
                                        <div class="bg-gray-50 p-4 rounded-lg">
                                            <p class="text-sm text-gray-600">Team Size</p>
                                            <p class="text-xl font-bold">${user.teamSize || 0}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Recent Bets -->
                                <div>
                                    <h4 class="font-bold text-gray-800 mb-4">Recent Bets</h4>
                                    ${data.recentBets && data.recentBets.length > 0 ? 
                                        `<div class="space-y-3">
                                            ${data.recentBets.slice(0, 5).map(bet => `
                                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                    <div>
                                                        <p class="font-medium">${bet.betOption} • ${bet.gameMode}</p>
                                                        <p class="text-sm text-gray-500">${new Date(bet.placedAt).toLocaleString()}</p>
                                                    </div>
                                                    <span class="font-bold ${bet.status === 'win' ? 'text-green-600' : bet.status === 'loss' ? 'text-red-600' : 'text-yellow-600'}">
                                                        ${bet.status === 'win' ? '+' : ''}₹${bet.amount}
                                                    </span>
                                                </div>
                                            `).join('')}
                                        </div>` : 
                                        `<p class="text-gray-500 text-center py-4">No recent bets</p>`
                                    }
                                </div>
                            </div>
                            
                            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                                <button onclick="editUserBalance('${user.userId}', '${user.name}', ${user.wallet})" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                    <i class="fas fa-wallet mr-2"></i> Edit Balance
                                </button>
                                <button onclick="this.closest('.fixed').remove()" 
                                        class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">
                                    Close
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('View user details error:', error);
                showAlert('Failed to load user details', 'error');
            }
        }

        // Edit User Balance
        function editUserBalance(userId, userName, currentBalance) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Edit Balance</h3>
                        <p class="text-gray-600 mt-1">User: ${userName}</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Current Balance</label>
                            <div class="text-2xl font-bold text-green-600">₹${currentBalance.toFixed(2)}</div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button id="addBalance" 
                                            onclick="selectBalanceAction('add')" 
                                            class="py-3 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-medium transition-all">
                                        <i class="fas fa-plus mr-2"></i> Add
                                    </button>
                                    <button id="subtractBalance" 
                                            onclick="selectBalanceAction('subtract')" 
                                            class="py-3 rounded-lg border-2 border-red-500 bg-red-50 text-red-700 font-medium transition-all">
                                        <i class="fas fa-minus mr-2"></i> Subtract
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (₹)</label>
                                <input type="number" id="balanceAmount" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                       placeholder="Enter amount" min="1">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Reason</label>
                                <textarea id="balanceReason" 
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                          rows="3" placeholder="Enter reason for balance change"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                        <button onclick="submitBalanceChange('${userId}')" 
                                class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            Update Balance
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function selectBalanceAction(action) {
            const addBtn = document.getElementById('addBalance');
            const subtractBtn = document.getElementById('subtractBalance');
            
            if (action === 'add') {
                addBtn.classList.add('bg-green-500', 'text-white');
                addBtn.classList.remove('bg-green-50', 'text-green-700');
                subtractBtn.classList.remove('bg-red-500', 'text-white');
                subtractBtn.classList.add('bg-red-50', 'text-red-700');
            } else {
                subtractBtn.classList.add('bg-red-500', 'text-white');
                subtractBtn.classList.remove('bg-red-50', 'text-red-700');
                addBtn.classList.remove('bg-green-500', 'text-white');
                addBtn.classList.add('bg-green-50', 'text-green-700');
            }
            
            window.selectedBalanceAction = action;
        }

        async function submitBalanceChange(userId) {
            const amount = parseFloat(document.getElementById('balanceAmount').value);
            const reason = document.getElementById('balanceReason').value;
            const action = window.selectedBalanceAction;
            
            if (!amount || amount <= 0) {
                showAlert('Please enter a valid amount', 'error');
                return;
            }
            
            if (!action) {
                showAlert('Please select an action (Add or Subtract)', 'error');
                return;
            }
            
            if (!reason) {
                showAlert('Please enter a reason for the balance change', 'error');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/admin/users/${userId}/balance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,
                        type: action,
                        reason: reason
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Balance ${action}ed successfully!`, 'success');
                    document.querySelector('.fixed').remove();
                    
                    // Refresh users list
                    if (currentPage === 'users') {
                        fetchUsers();
                    }
                } else {
                    showAlert(data.error || 'Failed to update balance', 'error');
                }
            } catch (error) {
                console.error('Balance update error:', error);
                showAlert('Failed to update balance', 'error');
            }
        }

        // Load Deposits
        async function loadDeposits() {
            currentPage = 'deposits';
            document.getElementById('pageTitle').textContent = 'Deposit Management';
            document.getElementById('pageSubtitle').textContent = 'Approve or reject user deposits';
            
            setActiveSidebar(document.querySelector('a[href="#deposits"]'));
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Deposit Requests</h2>
                                <p class="text-gray-600">Manage user deposit requests with screenshots</p>
                            </div>
                            <div class="mt-4 md:mt-0 flex space-x-3">
                                <select id="depositFilter" onchange="filterDeposits()" 
                                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <button onclick="refreshDeposits()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div id="depositsList">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Loading deposits...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            await fetchDeposits();
        }

        async function fetchDeposits(status = 'all') {
            try {
                let url = 'http://localhost:5000/api/admin/deposits';
                if (status !== 'all') {
                    url = `http://localhost:5000/api/admin/deposits/pending`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const deposits = data.deposits || [];
                    const depositsList = document.getElementById('depositsList');
                    
                    if (deposits.length === 0) {
                        depositsList.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                                <p class="text-lg">No deposits found</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let depositsHTML = '<div class="space-y-4">';
                    
                    deposits.forEach(deposit => {
                        const statusClass = deposit.status === 'approved' ? 'bg-green-100 text-green-800' :
                                          deposit.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                          'bg-yellow-100 text-yellow-800';
                        
                        depositsHTML += `
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <div class="bg-gray-50 p-4 flex flex-col md:flex-row md:items-center justify-between">
                                    <div>
                                        <div class="flex items-center">
                                            <span class="font-bold text-gray-800">Deposit ID: ${deposit.depositId}</span>
                                            <span class="ml-3 px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                                ${deposit.status.toUpperCase()}
                                            </span>
                                        </div>
                                        <div class="mt-2 text-sm text-gray-600">
                                            <span class="mr-4"><i class="fas fa-user mr-1"></i> ${deposit.mobile}</span>
                                            <span><i class="fas fa-calendar mr-1"></i> ${new Date(deposit.createdAt).toLocaleString()}</span>
                                        </div>
                                    </div>
                                    <div class="mt-2 md:mt-0">
                                        <span class="text-2xl font-bold text-green-600">₹${deposit.amount.toFixed(2)}</span>
                                    </div>
                                </div>
                                
                                <div class="p-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <p class="text-sm text-gray-600 mb-1">Method</p>
                                            <p class="font-medium">${deposit.method.toUpperCase()}</p>
                                            
                                            <p class="text-sm text-gray-600 mt-3 mb-1">UTR/Transaction ID</p>
                                            <p class="font-mono">${deposit.utr}</p>
                                            
                                            ${deposit.adminNotes ? `
                                                <p class="text-sm text-gray-600 mt-3 mb-1">Admin Notes</p>
                                                <p class="text-sm">${deposit.adminNotes}</p>
                                            ` : ''}
                                        </div>
                                        
                                        <div>
                                            <p class="text-sm text-gray-600 mb-2">Payment Screenshot</p>
                                            ${deposit.screenshot ? `
                                                <div class="relative">
                                                    <img src="${deposit.screenshot}" 
                                                         alt="Payment Screenshot" 
                                                         class="w-full h-48 object-contain border border-gray-200 rounded-lg">
                                                    <button onclick="viewScreenshot('${deposit.depositId}')" 
                                                            class="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-lg hover:bg-opacity-70 transition-all">
                                                        <i class="fas fa-expand"></i>
                                                    </button>
                                                </div>
                                            ` : `
                                                <div class="h-48 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-400">
                                                    <i class="fas fa-image text-3xl"></i>
                                                    <p class="ml-2">No screenshot</p>
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                    
                                    ${deposit.status === 'pending' ? `
                                        <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end space-x-3">
                                            <button onclick="rejectDeposit('${deposit.depositId}')" 
                                                    class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                                <i class="fas fa-times mr-2"></i> Reject
                                            </button>
                                            <button onclick="approveDeposit('${deposit.depositId}')" 
                                                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                                <i class="fas fa-check mr-2"></i> Approve
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    depositsHTML += '</div>';
                    depositsList.innerHTML = depositsHTML;
                }
            } catch (error) {
                console.error('Fetch deposits error:', error);
            }
        }

        function viewScreenshot(depositId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="relative max-w-4xl w-full">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="absolute top-4 right-4 bg-white text-gray-800 p-2 rounded-full hover:bg-gray-100 z-10">
                        <i class="fas fa-times"></i>
                    </button>
                    <div id="screenshotContainer" class="bg-white p-4 rounded-lg">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin"></i> Loading screenshot...
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load screenshot
            fetch(`http://localhost:5000/api/admin/deposits/${depositId}/screenshot`, {
                headers: {
                    'Authorization': `Bearer ${adminToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('screenshotContainer').innerHTML = `
                        <div class="text-center mb-4">
                            <h3 class="font-bold text-gray-800">Payment Screenshot</h3>
                            <p class="text-sm text-gray-600">Deposit ID: ${data.depositId}</p>
                        </div>
                        <img src="${data.screenshot}" 
                             alt="Payment Screenshot" 
                             class="w-full max-h-[70vh] object-contain rounded-lg">
                        <div class="mt-4 text-center text-gray-600">
                            <p>User: ${data.userId} • Amount: ₹${data.amount}</p>
                        </div>
                    `;
                }
            });
        }

        function approveDeposit(depositId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Approve Deposit</h3>
                        <p class="text-gray-600 mt-1">Deposit ID: ${depositId}</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Admin Notes (Optional)</label>
                            <textarea id="approveNotes" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none"
                                      rows="3" placeholder="Add notes for this approval"></textarea>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-medium text-green-800">Confirm Approval</p>
                                    <p class="text-sm text-green-600 mt-1">This will credit the amount to user's wallet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                        <button onclick="submitApproveDeposit('${depositId}')" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-check mr-2"></i> Approve Deposit
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function submitApproveDeposit(depositId) {
            const notes = document.getElementById('approveNotes').value;
            
            try {
                const response = await fetch(`http://localhost:5000/api/admin/deposits/${depositId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminNotes: notes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Deposit approved successfully!', 'success');
                    document.querySelector('.fixed').remove();
                    fetchDeposits();
                } else {
                    showAlert(data.error || 'Failed to approve deposit', 'error');
                }
            } catch (error) {
                console.error('Approve deposit error:', error);
                showAlert('Failed to approve deposit', 'error');
            }
        }

        function rejectDeposit(depositId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Reject Deposit</h3>
                        <p class="text-gray-600 mt-1">Deposit ID: ${depositId}</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Rejection *</label>
                            <textarea id="rejectReason" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                      rows="3" placeholder="Enter reason for rejecting this deposit" required></textarea>
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-500 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-medium text-red-800">Warning: This action cannot be undone</p>
                                    <p class="text-sm text-red-600 mt-1">User will be notified about the rejection</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                        <button onclick="submitRejectDeposit('${depositId}')" 
                                class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-times mr-2"></i> Reject Deposit
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function submitRejectDeposit(depositId) {
            const reason = document.getElementById('rejectReason').value;
            
            if (!reason) {
                showAlert('Please enter a rejection reason', 'error');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/admin/deposits/${depositId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminNotes: reason
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Deposit rejected successfully!', 'success');
                    document.querySelector('.fixed').remove();
                    fetchDeposits();
                } else {
                    showAlert(data.error || 'Failed to reject deposit', 'error');
                }
            } catch (error) {
                console.error('Reject deposit error:', error);
                showAlert('Failed to reject deposit', 'error');
            }
        }

        function filterDeposits() {
            const status = document.getElementById('depositFilter').value;
            fetchDeposits(status);
        }

        // Load Withdrawals
        async function loadWithdrawals() {
            currentPage = 'withdrawals';
            document.getElementById('pageTitle').textContent = 'Withdrawal Management';
            document.getElementById('pageSubtitle').textContent = 'Process user withdrawal requests';
            
            setActiveSidebar(document.querySelector('a[href="#withdrawals"]'));
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Withdrawal Requests</h2>
                                <p class="text-gray-600">Process user withdrawal requests</p>
                            </div>
                            <div class="mt-4 md:mt-0 flex space-x-3">
                                <select id="withdrawalFilter" onchange="filterWithdrawals()" 
                                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <button onclick="refreshWithdrawals()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div id="withdrawalsList">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Loading withdrawals...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            await fetchWithdrawals();
        }

        async function fetchWithdrawals(status = 'all') {
            try {
                let url = 'http://localhost:5000/api/admin/withdrawals';
                if (status === 'pending') {
                    url = 'http://localhost:5000/api/admin/withdrawals/pending';
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const withdrawals = data.withdrawals || [];
                    const withdrawalsList = document.getElementById('withdrawalsList');
                    
                    if (withdrawals.length === 0) {
                        withdrawalsList.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-wallet text-3xl mb-3"></i>
                                <p class="text-lg">No withdrawals found</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let withdrawalsHTML = '<div class="space-y-4">';
                    
                    withdrawals.forEach(withdrawal => {
                        const statusClass = withdrawal.status === 'approved' ? 'bg-green-100 text-green-800' :
                                          withdrawal.status === 'rejected' ? 'bg-red-100 text-red-800' :
                                          'bg-yellow-100 text-yellow-800';
                        
                        withdrawalsHTML += `
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <div class="bg-gray-50 p-4 flex flex-col md:flex-row md:items-center justify-between">
                                    <div>
                                        <div class="flex items-center">
                                            <span class="font-bold text-gray-800">Withdrawal ID: ${withdrawal.withdrawalId}</span>
                                            <span class="ml-3 px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                                ${withdrawal.status.toUpperCase()}
                                            </span>
                                        </div>
                                        <div class="mt-2 text-sm text-gray-600">
                                            <span class="mr-4"><i class="fas fa-user mr-1"></i> ${withdrawal.mobile}</span>
                                            <span><i class="fas fa-calendar mr-1"></i> ${new Date(withdrawal.createdAt).toLocaleString()}</span>
                                        </div>
                                    </div>
                                    <div class="mt-2 md:mt-0">
                                        <span class="text-2xl font-bold text-red-600">₹${withdrawal.amount.toFixed(2)}</span>
                                    </div>
                                </div>
                                
                                <div class="p-4">
                                    <div class="mb-4">
                                        <p class="text-sm text-gray-600 mb-1">Method</p>
                                        <p class="font-medium">${withdrawal.method.toUpperCase()}</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <p class="text-sm text-gray-600 mb-1">Account Details</p>
                                        <div class="bg-gray-50 p-3 rounded-lg">
                                            <pre class="text-sm">${JSON.stringify(withdrawal.accountDetails, null, 2)}</pre>
                                        </div>
                                    </div>
                                    
                                    ${withdrawal.adminNotes ? `
                                        <div class="mb-4">
                                            <p class="text-sm text-gray-600 mb-1">Admin Notes</p>
                                            <p class="text-sm">${withdrawal.adminNotes}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${withdrawal.status === 'pending' ? `
                                        <div class="pt-4 border-t border-gray-200 flex justify-end space-x-3">
                                            <button onclick="rejectWithdrawal('${withdrawal.withdrawalId}')" 
                                                    class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                                <i class="fas fa-times mr-2"></i> Reject
                                            </button>
                                            <button onclick="approveWithdrawal('${withdrawal.withdrawalId}')" 
                                                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                                <i class="fas fa-check mr-2"></i> Approve
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    withdrawalsHTML += '</div>';
                    withdrawalsList.innerHTML = withdrawalsHTML;
                }
            } catch (error) {
                console.error('Fetch withdrawals error:', error);
            }
        }

        function approveWithdrawal(withdrawalId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Approve Withdrawal</h3>
                        <p class="text-gray-600 mt-1">This will deduct amount from user's wallet</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Admin Notes (Optional)</label>
                            <textarea id="withdrawApproveNotes" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none"
                                      rows="3" placeholder="Add notes for this approval"></textarea>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-medium text-green-800">Confirm Approval</p>
                                    <p class="text-sm text-green-600 mt-1">Amount will be sent to user's account</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                        <button onclick="submitApproveWithdrawal('${withdrawalId}')" 
                                class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-check mr-2"></i> Approve Withdrawal
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function submitApproveWithdrawal(withdrawalId) {
            const notes = document.getElementById('withdrawApproveNotes').value;
            
            try {
                const response = await fetch(`http://localhost:5000/api/admin/withdrawals/${withdrawalId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminNotes: notes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Withdrawal approved successfully!', 'success');
                    document.querySelector('.fixed').remove();
                    fetchWithdrawals();
                } else {
                    showAlert(data.error || 'Failed to approve withdrawal', 'error');
                }
            } catch (error) {
                console.error('Approve withdrawal error:', error);
                showAlert('Failed to approve withdrawal', 'error');
            }
        }

        function rejectWithdrawal(withdrawalId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Reject Withdrawal</h3>
                        <p class="text-gray-600 mt-1">Withdrawal ID: ${withdrawalId}</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Rejection *</label>
                            <textarea id="withdrawRejectReason" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                      rows="3" placeholder="Enter reason for rejecting this withdrawal" required></textarea>
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-500 mr-3 text-xl"></i>
                                <div>
                                    <p class="font-medium text-red-800">User's balance will not be deducted</p>
                                    <p class="text-sm text-red-600 mt-1">User will be notified about the rejection</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                        <button onclick="submitRejectWithdrawal('${withdrawalId}')" 
                                class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-times mr-2"></i> Reject Withdrawal
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function submitRejectWithdrawal(withdrawalId) {
            const reason = document.getElementById('withdrawRejectReason').value;
            
            if (!reason) {
                showAlert('Please enter a rejection reason', 'error');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/admin/withdrawals/${withdrawalId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminNotes: reason
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Withdrawal rejected successfully!', 'success');
                    document.querySelector('.fixed').remove();
                    fetchWithdrawals();
                } else {
                    showAlert(data.error || 'Failed to reject withdrawal', 'error');
                }
            } catch (error) {
                console.error('Reject withdrawal error:', error);
                showAlert('Failed to reject withdrawal', 'error');
            }
        }

        function filterWithdrawals() {
            const status = document.getElementById('withdrawalFilter').value;
            fetchWithdrawals(status);
        }

        // Load Bets
        async function loadBets() {
            currentPage = 'bets';
            document.getElementById('pageTitle').textContent = 'Bet Management';
            document.getElementById('pageSubtitle').textContent = 'View and manage all bets';
            
            setActiveSidebar(document.querySelector('a[href="#bets"]'));
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-xl shadow mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center justify-between">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">All Bets</h2>
                                <p class="text-gray-600">View and manage betting history</p>
                            </div>
                            <div class="mt-4 md:mt-0 flex space-x-3">
                                <div class="relative">
                                    <input type="text" id="betSearch" 
                                           class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                           placeholder="Search bets...">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                                <button onclick="refreshBets()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="betStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="win">Win</option>
                                    <option value="loss">Loss</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Game Mode</label>
                                <select id="betGameModeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                                    <option value="all">All Modes</option>
                                    <option value="1min">1 Minute</option>
                                    <option value="3min">3 Minutes</option>
                                    <option value="5min">5 Minutes</option>
                                    <option value="10min">10 Minutes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                                <input type="date" id="betFromDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                                <input type="date" id="betToDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                            </div>
                        </div>
                        
                        <button onclick="applyBetFilters()" class="mb-6 bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-filter mr-2"></i> Apply Filters
                        </button>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-50 text-left text-sm font-medium text-gray-500">
                                        <th class="p-3">Bet ID</th>
                                        <th class="p-3">User</th>
                                        <th class="p-3">Game</th>
                                        <th class="p-3">Bet</th>
                                        <th class="p-3">Amount</th>
                                        <th class="p-3">Result</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Time</th>
                                        <th class="p-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="betsTableBody">
                                    <tr>
                                        <td colspan="9" class="p-8 text-center text-gray-500">
                                            <i class="fas fa-spinner fa-spin mr-2"></i> Loading bets...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            await fetchBets();
        }

        async function fetchBets(page = 1) {
            try {
                const status = document.getElementById('betStatusFilter')?.value || 'all';
                const gameMode = document.getElementById('betGameModeFilter')?.value || 'all';
                const fromDate = document.getElementById('betFromDate')?.value;
                const toDate = document.getElementById('betToDate')?.value;
                const search = document.getElementById('betSearch')?.value || '';
                
                let url = `http://localhost:5000/api/admin/bets?page=${page}&limit=20`;
                
                if (status !== 'all') url += `&status=${status}`;
                if (gameMode !== 'all') url += `&gameMode=${gameMode}`;
                if (fromDate) url += `&startDate=${fromDate}`;
                if (toDate) url += `&endDate=${toDate}`;
                if (search) url += `&userId=${search}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const bets = data.bets;
                    const stats = data.stats;
                    
                    // Update table
                    const tableBody = document.getElementById('betsTableBody');
                    if (bets.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="9" class="p-8 text-center text-gray-500">
                                    <i class="fas fa-coins text-3xl mb-3 block"></i>
                                    No bets found
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    let tableHTML = '';
                    bets.forEach(bet => {
                        const statusClass = bet.status === 'win' ? 'bg-green-100 text-green-800' :
                                          bet.status === 'loss' ? 'bg-red-100 text-red-800' :
                                          'bg-yellow-100 text-yellow-800';
                        
                        const resultText = bet.resultNumber !== undefined ? 
                                          `${bet.resultNumber} (${bet.resultColor})` : 'Pending';
                        
                        tableHTML += `
                            <tr class="table-row border-b border-gray-100 hover:bg-gray-50">
                                <td class="p-3">
                                    <div class="font-mono text-xs">${bet.betId}</div>
                                </td>
                                <td class="p-3">
                                    <div class="font-medium">${bet.mobile}</div>
                                </td>
                                <td class="p-3">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${bet.gameMode}</span>
                                </td>
                                <td class="p-3">
                                    <div>
                                        <span class="font-medium">${bet.betOption}</span>
                                        <div class="text-xs text-gray-500">${bet.betType}</div>
                                    </div>
                                </td>
                                <td class="p-3">
                                    <div class="font-bold">₹${bet.amount.toFixed(2)}</div>
                                </td>
                                <td class="p-3">
                                    <div class="font-medium">${resultText}</div>
                                </td>
                                <td class="p-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                        ${bet.status.toUpperCase()}
                                    </span>
                                </td>
                                <td class="p-3">
                                    <div class="text-sm text-gray-500">${new Date(bet.placedAt).toLocaleTimeString()}</div>
                                </td>
                                <td class="p-3">
                                    ${bet.status === 'pending' ? `
                                        <button onclick="settleBet('${bet.betId}')" 
                                                class="bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-sm transition-colors">
                                            <i class="fas fa-gavel"></i> Settle
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableBody.innerHTML = tableHTML;
                }
            } catch (error) {
                console.error('Fetch bets error:', error);
            }
        }

        function applyBetFilters() {
            fetchBets();
        }

        function settleBet(betId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Settle Bet</h3>
                        <p class="text-gray-600 mt-1">Manually settle this bet</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Result Number (0-9)</label>
                                <input type="number" id="settleNumber" min="0" max="9" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                       placeholder="Enter result number">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Result Color</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="selectColor('red')" id="colorRed" 
                                            class="py-3 rounded-lg border-2 border-red-500 bg-red-50 text-red-700 font-medium">
                                        Red
                                    </button>
                                    <button onclick="selectColor('green')" id="colorGreen" 
                                            class="py-3 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-medium">
                                        Green
                                    </button>
                                    <button onclick="selectColor('violet')" id="colorViolet" 
                                            class="py-3 rounded-lg border-2 border-purple-500 bg-purple-50 text-purple-700 font-medium">
                                        Violet
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Small/Big</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="selectSize('small')" id="sizeSmall" 
                                            class="py-3 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-medium">
                                        Small
                                    </button>
                                    <button onclick="selectSize('big')" id="sizeBig" 
                                            class="py-3 rounded-lg border-2 border-orange-500 bg-orange-50 text-orange-700 font-medium">
                                        Big
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                        <button onclick="submitSettleBet('${betId}')" 
                                class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-gavel mr-2"></i> Settle Bet
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function selectColor(color) {
            ['red', 'green', 'violet'].forEach(c => {
                const btn = document.getElementById(`color${c.charAt(0).toUpperCase() + c.slice(1)}`);
                if (c === color) {
                    btn.classList.add(`bg-${c}-500`, 'text-white');
                    btn.classList.remove(`bg-${c}-50`, `text-${c}-700`);
                } else {
                    btn.classList.remove(`bg-${c}-500`, 'text-white');
                    btn.classList.add(`bg-${c}-50`, `text-${c}-700`);
                }
            });
            window.selectedColor = color;
        }

        function selectSize(size) {
            ['small', 'big'].forEach(s => {
                const color = s === 'small' ? 'blue' : 'orange';
                const btn = document.getElementById(`size${s.charAt(0).toUpperCase() + s.slice(1)}`);
                if (s === size) {
                    btn.classList.add(`bg-${color}-500`, 'text-white');
                    btn.classList.remove(`bg-${color}-50`, `text-${color}-700`);
                } else {
                    btn.classList.remove(`bg-${color}-500`, 'text-white');
                    btn.classList.add(`bg-${color}-50`, `text-${color}-700`);
                }
            });
            window.selectedSize = size;
        }

        async function submitSettleBet(betId) {
            const number = parseInt(document.getElementById('settleNumber').value);
            const color = window.selectedColor;
            const size = window.selectedSize;
            
            if (isNaN(number) || number < 0 || number > 9) {
                showAlert('Please enter a valid number between 0-9', 'error');
                return;
            }
            
            if (!color) {
                showAlert('Please select a color', 'error');
                return;
            }
            
            if (!size) {
                showAlert('Please select small or big', 'error');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5000/api/admin/bets/${betId}/settle`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resultNumber: number,
                        resultColor: color,
                        resultSmallBig: size
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Bet settled as ${data.bet.status}!`, 'success');
                    document.querySelector('.fixed').remove();
                    fetchBets();
                } else {
                    showAlert(data.error || 'Failed to settle bet', 'error');
                }
            } catch (error) {
                console.error('Settle bet error:', error);
                showAlert('Failed to settle bet', 'error');
            }
        }

        // Load Games Control
        async function loadGames() {
            currentPage = 'games';
            document.getElementById('pageTitle').textContent = 'Game Control';
            document.getElementById('pageSubtitle').textContent = 'Manage games and generate results';
            
            setActiveSidebar(document.querySelector('a[href="#games"]'));
            
            document.getElementById('contentArea').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Game Status -->
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Game Status</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium">1 Minute Game</p>
                                    <p class="text-sm text-gray-500">Instant results enabled</p>
                                </div>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">ACTIVE</span>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium">3 Minutes Game</p>
                                    <p class="text-sm text-gray-500">Instant results enabled</p>
                                </div>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">ACTIVE</span>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium">5 Minutes Game</p>
                                    <p class="text-sm text-gray-500">Instant results enabled</p>
                                </div>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">ACTIVE</span>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium">10 Minutes Game</p>
                                    <p class="text-sm text-gray-500">Instant results enabled</p>
                                </div>
                                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">ACTIVE</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manual Result Generation -->
                    <div class="bg-white rounded-xl shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">Manual Result Generation</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Game Mode</label>
                                <select id="gameModeSelect" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                                    <option value="1min">1 Minute</option>
                                    <option value="3min">3 Minutes</option>
                                    <option value="5min">5 Minutes</option>
                                    <option value="10min">10 Minutes</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Period ID (Optional)</label>
                                <input type="text" id="periodId" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                       placeholder="Leave empty for current period">
                            </div>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-3 text-xl"></i>
                                    <div>
                                        <p class="font-medium text-yellow-800">Manual Result Generation</p>
                                        <p class="text-sm text-yellow-600 mt-1">This will settle all pending bets for the selected period</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="generateRandomResult()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium transition-colors">
                                    <i class="fas fa-random mr-2"></i> Generate Random
                                </button>
                                <button onclick="openManualResultForm()" 
                                        class="bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg font-medium transition-colors">
                                    <i class="fas fa-edit mr-2"></i> Set Manual
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function generateRandomResult() {
            const gameMode = document.getElementById('gameModeSelect').value;
            const periodId = document.getElementById('periodId').value;
            
            try {
                const response = await fetch('http://localhost:5000/api/admin/generate-result', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gameMode: gameMode,
                        periodId: periodId || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Random result generated for ${gameMode} game! ${data.settlement.processed} bets settled.`, 'success');
                } else {
                    showAlert(data.error || 'Failed to generate result', 'error');
                }
            } catch (error) {
                console.error('Generate result error:', error);
                showAlert('Failed to generate result', 'error');
            }
        }

        function openManualResultForm() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Set Manual Result</h3>
                        <p class="text-gray-600 mt-1">Manually set game result</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Game Mode</label>
                                <select id="manualGameMode" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                                    <option value="1min">1 Minute</option>
                                    <option value="3min">3 Minutes</option>
                                    <option value="5min">5 Minutes</option>
                                    <option value="10min">10 Minutes</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Period ID</label>
                                <input type="text" id="manualPeriodId" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                       placeholder="Enter period ID" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Number (0-9)</label>
                                <input type="number" id="manualNumber" min="0" max="9" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none"
                                       placeholder="0" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                                <select id="manualColor" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                                    <option value="red">Red</option>
                                    <option value="green">Green</option>
                                    <option value="violet">Violet</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Small/Big</label>
                                <select id="manualSize" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent outline-none">
                                    <option value="small">Small</option>
                                    <option value="big">Big</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                        <button onclick="submitManualResult()" 
                                class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-check mr-2"></i> Set Result
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function submitManualResult() {
            const gameMode = document.getElementById('manualGameMode').value;
            const periodId = document.getElementById('manualPeriodId').value;
            const number = parseInt(document.getElementById('manualNumber').value);
            const color = document.getElementById('manualColor').value;
            const size = document.getElementById('manualSize').value;
            
            if (!periodId) {
                showAlert('Please enter period ID', 'error');
                return;
            }
            
            if (isNaN(number) || number < 0 || number > 9) {
                showAlert('Please enter a valid number between 0-9', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/admin/generate-result', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        gameMode: gameMode,
                        periodId: periodId,
                        number: number,
                        color: color,
                        smallBig: size
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Manual result set for ${gameMode} period ${periodId}!`, 'success');
                    document.querySelector('.fixed').remove();
                } else {
                    showAlert(data.error || 'Failed to set result', 'error');
                }
            } catch (error) {
                console.error('Set manual result error:', error);
                showAlert('Failed to set result', 'error');
            }
        }

        // Refresh functions
        function refreshUsers() {
            if (currentPage === 'users') {
                fetchUsers();
                showAlert('Users list refreshed', 'info');
            }
        }

        function refreshDeposits() {
            if (currentPage === 'deposits') {
                fetchDeposits();
                showAlert('Deposits list refreshed', 'info');
            }
        }

        function refreshWithdrawals() {
            if (currentPage === 'withdrawals') {
                fetchWithdrawals();
                showAlert('Withdrawals list refreshed', 'info');
            }
        }

        function refreshBets() {
            if (currentPage === 'bets') {
                fetchBets();
                showAlert('Bets list refreshed', 'info');
            }
        }

        // Initialize
        updateServerTime();
    </script>
</body>
</html>